import{m as te,r as C,z as ke,o as Ne,i as Pe,f as b,h as r,t as m,n as B,O as me,v as N,F as re,g as le,M as he,P as Te,s as pe,N as Ae,e as w,A as Fe,a as We,b as Me}from"./vendor.BJKvz4Yw.js";import{_ as Ee,u as Be,b as oe,c as ve}from"./index.DnUnV9d6.js";import{S as Le}from"./SkeletonLoader.DhWxvyw4.js";import{V as fe}from"./charts.CIWCquZQ.js";const Ve={class:"min-h-screen"},Re={class:"bg-gray-800/80 backdrop-blur-md border-b border-white/10 sticky top-0 z-10"},Ke={class:"px-3 py-2"},Oe={class:"flex items-center gap-2 mb-2"},$e={class:"text-base font-bold text-white flex-1 text-center"},Ie={class:"flex items-start justify-between"},Ue={class:"flex-1"},ze={key:0,class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},De={key:1,class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},je={class:"text-right text-xs space-y-1"},qe={class:"flex items-center justify-end gap-2"},He={class:"text-gray-400"},Qe={class:"text-white font-medium"},Xe={class:"flex items-center justify-end gap-2"},Ge={class:"text-gray-400"},Je={class:"text-white font-medium"},Ze={class:"flex items-center justify-end gap-2"},Ye={class:"text-gray-400"},et={class:"text-white font-medium"},tt={class:"pb-20"},rt={class:"px-4"},lt={class:"flex gap-4 overflow-x-auto scrollbar-hide border-b border-white/10"},ot=["onClick"],at={key:0,class:"absolute bottom-0 left-0 right-0 h-0.5 bg-blue-400"},st={class:"glass-card-no-hover rounded-none md:rounded-xl p-2 md:p-4 mb-3 md:mb-4 mx-0 md:mx-4"},it={key:0,class:"glass-card-no-hover rounded-none md:rounded-xl p-4 mb-4 mx-0 md:mx-4"},nt={class:"space-y-2"},ct={key:1,class:"glass-card-no-hover rounded-none md:rounded-xl p-4 mb-4 mx-0 md:mx-4"},ut={class:"font-bold text-white mb-3"},dt={class:"overflow-x-auto"},mt={class:"w-full text-sm"},ht={class:"text-gray-400 border-b border-white/10"},pt={class:"text-left py-2 px-2"},vt={class:"text-left py-2 px-2"},ft={class:"text-left py-2 px-2"},gt={class:"py-2 px-2 text-gray-300"},bt={class:"fixed bottom-0 left-0 right-0 bg-gray-800/80 backdrop-blur-md border-t border-white/10 px-3 py-2 z-20"},wt={class:"grid grid-cols-2 gap-3 max-w-md mx-auto"},ge="https://api.binance.com/api/v3",yt="wss://stream.binance.com:9443/ws/!ticker@arr",xt=3e4,_t={__name:"Kline",setup(Ct){const{t:S}=Be(),D=Te(),be=Ae(),P=te(()=>window.innerWidth<768),j=te(()=>P.value?320:400),q=te(()=>P.value?72:120),L=C(["BTC","ETH","BNB","XRP","ADA","DOGE","DOT","LTC","BCH","ETC","NEO","IOTA","LUNA"].map(t=>`${t}/USDT`)),y=C((()=>{if(D.query.symbol){let t=D.query.symbol.trim();if(t.includes("/")){if(L.value.includes(t))return t}else if(t=t.replace(/USDT$/,"/USDT"),L.value.includes(t))return t}return L.value[0]||"BTC/USDT"})()),O=C("1min"),we=["Realtime","1min","5min","15min","30min","1hour","1day","1week","1m"],s=C(null),ae=C([]),V=C(!0),v=C(null),f=C(null);let d=null,g=null,x=null,H=null,Q=null,X=null,G=null;const ye=t=>{try{if(!d||!(t!=null&&t.length))return;const e=t.length,o=P.value?55:80,i=Math.max(0,e-o),a=t[i].time,c=t[e-1].time;d.applyOptions({timeScale:{rightOffset:6,barSpacing:P.value?7:6},rightPriceScale:{autoScale:!0,scaleMargins:{top:.12,bottom:.18}}}),d.timeScale().setVisibleRange({from:a,to:c}),g&&g.timeScale().setVisibleRange({from:a,to:c})}catch(e){console.warn("applyDefaultViewport error:",e)}};let T=null,se=!0,J=!1,A=null;const $=t=>{const e=Number(t);return!Number.isFinite(e)||e===0?"0.00":e>=1?e.toFixed(2):e>=.01?e.toFixed(4):e.toFixed(8)},xe=t=>t?parseFloat(t).toFixed(6):"0.0000",_e=t=>t?t>=1e9?(t/1e9).toFixed(2)+"B":t>=1e6?(t/1e6).toFixed(2)+"M":t>=1e3?(t/1e3).toFixed(2)+"K":t.toFixed(2):"0.00",Ce=t=>{const e=new Date(t),o=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0");return`${o}:${i}:${a}`},ie=async()=>{V.value=!0;const t=y.value.replace("/","");try{await Promise.all([ne(t),Z(t),d&&x?U():Promise.resolve()])}finally{V.value=!1}};let F=null,W=null,M=null,n=null,E=null,I=1e3;const ne=async t=>{F&&F.abort(),F=new AbortController;try{const e=await oe.get(`/market/ticker/${t}/24h`,{signal:F.signal});e.data&&(s.value?(s.value.price=Number(e.data.price)||s.value.price,s.value.priceChangePercent=Number(e.data.priceChangePercent)||s.value.priceChangePercent,s.value.priceChange=Number(e.data.priceChange)||s.value.priceChange,s.value.volume=Number(e.data.volume)||s.value.volume,s.value.highPrice=Number(e.data.highPrice)||s.value.highPrice,s.value.lowPrice=Number(e.data.lowPrice)||s.value.lowPrice):s.value={price:Number(e.data.price)||0,priceChangePercent:Number(e.data.priceChangePercent)||0,priceChange:Number(e.data.priceChange)||0,volume:Number(e.data.volume)||0,highPrice:Number(e.data.highPrice)||0,lowPrice:Number(e.data.lowPrice)||0})}catch(e){if(e.name==="AbortError"||e.name==="CanceledError")return;console.error("Error loading ticker:",e)}},Z=async t=>{W&&W.abort(),W=new AbortController;try{let e=[];const o=await oe.get(`/market/trades/${t}`,{params:{limit:50},signal:W.signal});if(e=Array.isArray(o.data)?o.data:[],!e.length)try{e=((await ve.get(`${ge}/trades`,{params:{symbol:t,limit:50}})).data||[]).map(a=>({id:a.id,price:Number(a.price),quantity:Number(a.qty),time:a.time,isBuyerMaker:a.isBuyerMaker}))}catch(i){console.warn("Binance trades fallback failed:",(i==null?void 0:i.message)||i)}ae.value=e}catch(e){if(e.name==="AbortError"||e.name==="CanceledError")return;console.error("Error loading recent trades:",e)}},U=async()=>{M&&M.abort(),M=new AbortController;try{let t=0;for(;(!d||!x)&&t<10;)t>0&&(console.log("Chart not initialized yet, waiting...",t),await new Promise(l=>setTimeout(l,200))),t++;if(!d||!x){console.error("Chart still not initialized after retries");return}const e=y.value.replace("/","");let o=O.value.toLowerCase();const a={realtime:"1m","1min":"1m","5min":"5m","15min":"15m","30min":"30m","1hour":"1h","1day":"1d","1week":"1w","1m":"1M"}[o]||"1m",c=await oe.get(`/market/klines/${e}`,{params:{interval:a,limit:200},signal:M.signal});let h=Array.isArray(c.data)?c.data:[];if(!h.length)try{h=((await ve.get(`${ge}/klines`,{params:{symbol:e,interval:a,limit:200}})).data||[]).map(k=>({time:k[0],open:k[1],high:k[2],low:k[3],close:k[4],volume:k[5]}))}catch(l){console.warn("Binance klines fallback failed:",(l==null?void 0:l.message)||l)}if(!h||h.length===0){console.warn("No klines data received");return}const p=h.filter(l=>l&&l.time&&l.open!==void 0&&l.high!==void 0&&l.low!==void 0&&l.close!==void 0).map(l=>({time:typeof l.time=="number"?Math.floor(l.time/1e3):Math.floor(new Date(l.time).getTime()/1e3),open:parseFloat(l.open),high:parseFloat(l.high),low:parseFloat(l.low),close:parseFloat(l.close)})).filter(l=>l.time>0&&!isNaN(l.open)&&!isNaN(l.high)&&!isNaN(l.low)&&!isNaN(l.close)&&l.open>0&&l.high>0&&l.low>0&&l.close>0),_=h.map(l=>({time:Math.floor(l.time/1e3),value:parseFloat(l.volume),color:parseFloat(l.close)>=parseFloat(l.open)?"#43A047":"#E53935"})),R=Y(p,5),K=Y(p,10),u=Y(p,20);if(x&&p.length>0?(console.log("Setting candlestick data:",p.length,"candles"),x.setData(p),x.applyOptions({visible:!0,priceLineVisible:!1,lastValueVisible:!0}),se&&p.length>0&&setTimeout(()=>{ye(p),se=!1},150)):console.warn("No candlestick data to display:",{hasSeries:!!x,dataLength:p.length}),H&&_.length>0&&g&&H.setData(_),p.length>0&&(Q&&R.length>0&&Q.setData(R),X&&K.length>0&&X.setData(K),G&&u.length>0&&G.setData(u)),await pe(),d&&v.value&&p.length>0){const l=v.value.clientWidth;l>0&&d.applyOptions({width:l})}if(g&&f.value&&_.length>0){const l=f.value.clientWidth;l>0&&g.applyOptions({width:l})}}catch(t){if(t.name==="AbortError"||t.name==="CanceledError")return;console.error("Error loading klines:",t)}},Y=(t,e)=>{const o=[];for(let i=0;i<t.length;i++){if(i<e-1)continue;let a=0;for(let c=0;c<e;c++)a+=t[i-c].close;o.push({time:t[i].time,value:a/e})}return o},ce=t=>{const e=y.value.replace("/","");be.push({path:"/contracts",query:{symbol:e,side:t}})},Se=async()=>{if(await pe(),v.value&&!d){let t=0;for(;(!v.value.clientWidth||v.value.clientWidth===0)&&t<10;)await new Promise(i=>setTimeout(i,50)),t++;const e=v.value.clientWidth||800;if(e===0){console.error("Chart container has no width");return}if(d=fe(v.value,{layout:{background:{color:"transparent"},textColor:"#ffffff"},grid:{vertLines:{color:"rgba(255, 255, 255, 0.1)"},horzLines:{color:"rgba(255, 255, 255, 0.1)"}},width:e,height:j.value,timeScale:{timeVisible:!0,secondsVisible:!1,rightOffset:6,barSpacing:P.value?7:6},rightPriceScale:{autoScale:!0,scaleMargins:{top:.12,bottom:.18}},watermark:{visible:!1}}),P.value,x=d.addCandlestickSeries({upColor:"#43A047",downColor:"#E53935",borderUpColor:"#43A047",borderDownColor:"#E53935",wickUpColor:"#43A047",wickDownColor:"#E53935",priceFormat:{type:"price",precision:2,minMove:.01},visible:!0,priceLineVisible:!1,lastValueVisible:!0}),Q=d.addLineSeries({color:"#FF6B9D",lineWidth:2,title:"MA5"}),X=d.addLineSeries({color:"#4ECDC4",lineWidth:2,title:"MA10"}),G=d.addLineSeries({color:"#95E1D3",lineWidth:2,title:"MA20"}),f.value){let i=0;for(;(!f.value.clientWidth||f.value.clientWidth===0)&&i<10;)await new Promise(c=>setTimeout(c,50)),i++;const a=f.value.clientWidth||800;g=fe(f.value,{layout:{background:{color:"transparent"},textColor:"#ffffff"},grid:{vertLines:{visible:!1},horzLines:{color:"rgba(255, 255, 255, 0.1)"}},width:a,height:q.value,timeScale:{visible:!1},rightPriceScale:{visible:!0},watermark:{visible:!1}}),H=g.addHistogramSeries({priceFormat:{type:"volume"},priceScaleId:"",scaleMargins:{top:.8,bottom:0}}),d.timeScale().subscribeVisibleTimeRangeChange(c=>{if(c&&g)try{const h=g.timeScale();h&&c.from&&c.to&&h.setVisibleRange(c)}catch(h){console.warn("Error syncing time scales:",h)}})}const o=()=>{v.value&&v.value.querySelectorAll('svg[class*="watermark"], svg[data-name="watermark"], .watermark, [class*="tradingview"], svg text[class*="watermark"], svg text[data-name="watermark"]').forEach(a=>{a.style.display="none",a.style.visibility="hidden",a.style.opacity="0",a.remove()}),f.value&&f.value.querySelectorAll('svg[class*="watermark"], svg[data-name="watermark"], .watermark, [class*="tradingview"], svg text[class*="watermark"], svg text[data-name="watermark"]').forEach(a=>{a.style.display="none",a.style.visibility="hidden",a.style.opacity="0",a.remove()})};setTimeout(o,100),setTimeout(o,500),setTimeout(o,1e3),v.value&&f.value&&(T=new MutationObserver(()=>{o()}),T.observe(v.value,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","data-name"]}),T.observe(f.value,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","data-name"]}))}},ue=t=>{if(!(t!=null&&t.s))return;const e=t.s,o=y.value.replace("/","");if(e===o&&console.log("[Kline WS] Processing update for",e,"price:",t.c),e!==o)return;const i=Number.parseFloat(t.c),a=Number.parseFloat(t.P)||0,c=Number.parseFloat(t.p)||0,h=Number.parseFloat(t.v)||0,p=Number.parseFloat(t.h)||0,_=Number.parseFloat(t.l)||0;Number.isFinite(i)&&(s.value?(s.value.price=i,s.value.priceChangePercent=a,s.value.priceChange=c,s.value.volume=h,s.value.highPrice=p,s.value.lowPrice=_,console.log("[Kline WS] Updated ticker:",e,"price:",i,"change%:",a)):(s.value={price:i,priceChangePercent:a,priceChange:c,volume:h,highPrice:p,lowPrice:_},console.log("[Kline WS] Created new ticker object:",s.value)))},z=()=>{if((n==null?void 0:n.readyState)!==WebSocket.OPEN){console.log("[Kline WS] Connecting to Binance...");try{n&&(n.onopen=null,n.onmessage=null,n.onerror=null,n.onclose=null,n.close())}catch(t){console.warn("[Kline WS] Cleanup error:",t)}try{n=new WebSocket(yt),n.onopen=()=>{console.log("[Kline WS] Connected successfully"),I=1e3},n.onmessage=t=>{try{const e=JSON.parse(t.data);Array.isArray(e)?(e.length>0&&console.log("[Kline WS] Received array of",e.length,"tickers"),e.forEach(ue)):e.s&&(console.log("[Kline WS] Received single ticker:",e.s),ue(e))}catch(e){console.error("[Kline WS] Parse error:",e)}},n.onerror=t=>{console.error("[Kline WS] Error:",t)},n.onclose=t=>{console.warn("[Kline WS] Closed:",t.code,t.reason),n=null,de()}}catch(t){console.error("[Kline WS] Setup error:",t),de()}}},de=()=>{E||(E=setTimeout(()=>{E=null,z()},I),I=Math.min(I*2,xt))};ke(()=>D.query.symbol,t=>{if(t){let e=t.trim();if(e.includes("/")){if(L.value.includes(e)){if(y.value=e,ie(),n){try{n.close()}catch(o){console.warn("[Kline WS] Error closing old connection:",o)}n=null}z()}}else if(e=e.replace(/USDT$/,"/USDT"),L.value.includes(e)){if(y.value=e,ie(),n){try{n.close()}catch(o){console.warn("[Kline WS] Error closing old connection:",o)}n=null}z()}}},{immediate:!0});let ee=null;return Ne(async()=>{await Se();const t=y.value.replace("/","");V.value=!0;try{await Promise.all([ne(t),Z(t)]),d&&x&&await U()}finally{V.value=!1}A=()=>{try{if(d&&v.value){const o=v.value.clientWidth;o>0&&d.applyOptions({width:o,height:j.value})}if(g&&f.value){const o=f.value.clientWidth;o>0&&g.applyOptions({width:o,height:q.value})}}catch(o){console.warn("handleResize error:",o)}},window.addEventListener("resize",A,{passive:!0}),setTimeout(A,250),z();let e=!1;ee=setInterval(async()=>{if(!e){e=!0;try{const o=y.value.replace("/","");await Promise.all([Z(o),U()])}catch(o){console.error("Error refreshing market data:",o)}finally{e=!1}}},3e3)}),Pe(()=>{F&&F.abort(),W&&W.abort(),M&&M.abort(),E&&(clearTimeout(E),E=null);try{n&&(n.onopen=null,n.onmessage=null,n.onerror=null,n.onclose=null,n.close(),n=null)}catch{}T&&(T.disconnect(),T=null),ee&&clearInterval(ee),A&&(window.removeEventListener("resize",A),A=null),d&&d.remove(),g&&g.remove()}),(t,e)=>{var o,i,a,c,h,p,_,R,K;return w(),b("div",Ve,[r("div",Re,[r("div",Ke,[r("div",Oe,[r("button",{onClick:e[0]||(e[0]=u=>t.$router.back()),class:"p-1.5 hover:bg-gray-700 rounded-lg transition-colors"},[...e[3]||(e[3]=[r("svg",{class:"w-5 h-5 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])]),r("h1",$e,m(y.value),1),e[4]||(e[4]=r("div",{class:"w-8"},null,-1))]),r("div",Ie,[r("div",Ue,[r("div",{class:B(["text-xl font-bold mb-1",(Number((o=s.value)==null?void 0:o.priceChangePercent)||0)>=0?"text-green-400":"text-red-400"])},m($(((i=s.value)==null?void 0:i.price)||0)),3),r("div",{class:B(["inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium",(Number((a=s.value)==null?void 0:a.priceChangePercent)||0)>=0?"bg-green-500/20 text-green-300":"bg-red-500/20 text-red-300"])},[(Number((c=s.value)==null?void 0:c.priceChangePercent)||0)<0?(w(),b("svg",ze,[...e[5]||(e[5]=[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])])):(w(),b("svg",De,[...e[6]||(e[6]=[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 15l7-7 7 7"},null,-1)])])),me(" "+m((Number((h=s.value)==null?void 0:h.priceChangePercent)||0)>=0?"+":"")+m((Number((p=s.value)==null?void 0:p.priceChangePercent)||0).toFixed(2))+"% ",1)],2)]),r("div",je,[r("div",qe,[r("span",He,m(N(S)("kline.high")),1),r("span",Qe,m($(((_=s.value)==null?void 0:_.highPrice)||0)),1)]),r("div",Xe,[r("span",Ge,m(N(S)("kline.low")),1),r("span",Je,m($(((R=s.value)==null?void 0:R.lowPrice)||0)),1)]),r("div",Ze,[r("span",Ye,m(N(S)("kline.volume24h")),1),r("span",et,m(_e(((K=s.value)==null?void 0:K.volume)||0)),1)])])])])]),r("main",tt,[r("div",rt,[r("div",lt,[(w(),b(re,null,le(we,u=>r("button",{key:u,onClick:l=>{O.value=u,Fe(J)?J.value=!1:J=!1,U()},class:B(["px-2 py-2 text-xs font-medium whitespace-nowrap transition-all relative",O.value===u?"text-blue-400":"text-gray-400 hover:text-gray-300"])},[me(m(u)+" ",1),O.value===u?(w(),b("span",at)):We("",!0)],10,ot)),64))])]),r("div",st,[r("div",{ref_key:"chartContainer",ref:v,class:"w-full chart-no-watermark",style:he({height:`${j.value}px`})},null,4),r("div",{ref_key:"volumeContainer",ref:f,class:"w-full mt-2 chart-no-watermark",style:he({height:`${q.value}px`})},null,4)]),V.value?(w(),b("div",it,[e[7]||(e[7]=r("div",{class:"h-6 bg-white/10 rounded w-32 mb-3 animate-pulse"},null,-1)),r("div",nt,[(w(),b(re,null,le(10,u=>Me(Le,{key:u,type:"table-row"})),64))])])):(w(),b("div",ct,[r("h3",ut,m(N(S)("kline.marketTrades")),1),r("div",dt,[r("table",mt,[r("thead",null,[r("tr",ht,[r("th",pt,m(N(S)("kline.time")),1),e[8]||(e[8]=r("th",{class:"text-left py-2 px-2"},"Direction",-1)),r("th",vt,m(N(S)("kline.price")),1),r("th",ft,m(N(S)("kline.quantity")),1)])]),r("tbody",null,[(w(!0),b(re,null,le(ae.value.slice(0,20),u=>(w(),b("tr",{key:u.id,class:"border-b border-white/5"},[r("td",gt,m(Ce(u.time)),1),r("td",{class:B(["py-2 px-2 font-medium",u.isBuyerMaker?"text-red-400":"text-green-400"])},m(u.isBuyerMaker?"Inbuy":"Outsell"),3),r("td",{class:B(["py-2 px-2",u.isBuyerMaker?"text-red-400":"text-green-400"])},m($(u.price)),3),r("td",{class:B(["py-2 px-2",u.isBuyerMaker?"text-red-400":"text-green-400"])},m(xe(u.quantity)),3)]))),128))])])])]))]),r("div",bt,[r("div",wt,[r("button",{onClick:e[1]||(e[1]=u=>ce("buy")),class:"bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-2.5 rounded-lg text-base transition-colors shadow-lg"}," Up "),r("button",{onClick:e[2]||(e[2]=u=>ce("sell")),class:"bg-red-500 hover:bg-red-600 active:bg-red-700 text-white font-bold py-2.5 rounded-lg text-base transition-colors shadow-lg"}," Fall ")])])])}}},Ft=Ee(_t,[["__scopeId","data-v-62933719"]]);export{Ft as default};
