<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" type="image/x-icon" href="/fav.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <title>Trading App</title>
  </head>
  <body>
    <div id="app"></div>
    <script>
      // Prevent infinite reload loops
      const RELOAD_ATTEMPT_KEY = 'app_reload_attempt';
      const MAX_RELOAD_ATTEMPTS = 1;
      
      // Check if we've already tried reloading
      const reloadAttempts = parseInt(sessionStorage.getItem(RELOAD_ATTEMPT_KEY) || '0');
      const urlParams = new URLSearchParams(window.location.search);
      const isReloadAttempt = urlParams.get('_clear') === '1' || urlParams.get('_nocache') === '1';
      
      // If this is a reload attempt and we've already tried, show error page
      if (isReloadAttempt && reloadAttempts >= MAX_RELOAD_ATTEMPTS) {
        document.body.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; padding: 20px; text-align: center; font-family: system-ui, sans-serif; background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);">
            <h1 style="color: #f97316; margin-bottom: 16px; font-size: 32px; font-weight: bold;">Application Error</h1>
            <p style="color: #e5e7eb; margin-bottom: 24px; font-size: 18px;">Please clear your browser cache and reload the page.</p>
            <button id="hardRefreshBtn" onclick="
              (function() {
                // Clear all caches
                if ('caches' in window) {
                  caches.keys().then(names => {
                    names.forEach(name => caches.delete(name).catch(() => {}));
                  });
                }
                // Clear service workers
                if ('serviceWorker' in navigator) {
                  navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(reg => reg.unregister());
                  });
                }
                // Clear storage
                sessionStorage.clear();
                const authTokens = {
                  accessToken: localStorage.getItem('accessToken'),
                  refreshToken: localStorage.getItem('refreshToken'),
                };
                localStorage.clear();
                Object.entries(authTokens).forEach(([key, value]) => {
                  if (value) localStorage.setItem(key, value);
                });
                // Hard reload with cache bypass
                window.location.href = window.location.origin + window.location.pathname + '?v=' + Date.now() + '&_hard=1';
              })();
            " style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; margin-bottom: 12px;">
              Clear Cache & Reload
            </button>
            <button onclick="sessionStorage.removeItem('app_reload_attempt'); location.href = location.pathname;" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
              Try Again (Simple Reload)
            </button>
          </div>
        `;
        throw new Error('Stopped infinite reload loop');
      }
      
      // Global error handler to catch ref errors BEFORE Vue loads
      window.addEventListener('error', function(event) {
        if (event.message && (event.message.includes('refs') || event.message.includes('Cannot read properties'))) {
          console.error('Critical error detected, clearing cache...');
          event.preventDefault();
          
          // Increment reload counter
          const currentAttempts = parseInt(sessionStorage.getItem(RELOAD_ATTEMPT_KEY) || '0');
          sessionStorage.setItem(RELOAD_ATTEMPT_KEY, (currentAttempts + 1).toString());
          
          // Clear everything
          if ('caches' in window) {
            caches.keys().then(names => {
              names.forEach(name => caches.delete(name).catch(() => {}));
            });
          }
          
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
              registrations.forEach(reg => reg.unregister());
            });
          }
          
          // Preserve auth
          const authTokens = {
            accessToken: localStorage.getItem('accessToken'),
            refreshToken: localStorage.getItem('refreshToken'),
          };
          
          localStorage.clear();
          sessionStorage.setItem(RELOAD_ATTEMPT_KEY, currentAttempts + 1);
          
          Object.entries(authTokens).forEach(([key, value]) => {
            if (value) localStorage.setItem(key, value);
          });
          
          // Force reload with cache bypass (only if we haven't exceeded max attempts)
          if (currentAttempts < MAX_RELOAD_ATTEMPTS) {
            // More aggressive cache clearing before reload
            setTimeout(() => {
              // Add cache-busting headers via meta refresh as fallback
              const meta = document.createElement('meta');
              meta.httpEquiv = 'Cache-Control';
              meta.content = 'no-cache, no-store, must-revalidate';
              document.head.appendChild(meta);
              
              // Force reload with multiple cache-busting techniques
              const url = window.location.origin + window.location.pathname + '?v=' + Date.now() + '&_clear=1&_t=' + performance.now();
              window.location.replace(url); // Use replace instead of href to prevent back button issues
            }, 100);
          } else {
            // Show error page instead of reloading
            document.body.innerHTML = `
              <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; padding: 20px; text-align: center; font-family: system-ui, sans-serif; background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);">
                <h1 style="color: #f97316; margin-bottom: 16px; font-size: 32px; font-weight: bold;">Application Error</h1>
                <p style="color: #e5e7eb; margin-bottom: 24px; font-size: 18px;">Please clear your browser cache and reload the page.</p>
                <button id="hardRefreshBtn" onclick="
                  (function() {
                    // Clear all caches
                    if ('caches' in window) {
                      caches.keys().then(names => {
                        names.forEach(name => caches.delete(name).catch(() => {}));
                      });
                    }
                    // Clear service workers
                    if ('serviceWorker' in navigator) {
                      navigator.serviceWorker.getRegistrations().then(registrations => {
                        registrations.forEach(reg => reg.unregister());
                      });
                    }
                    // Clear storage
                    sessionStorage.clear();
                    const authTokens = {
                      accessToken: localStorage.getItem('accessToken'),
                      refreshToken: localStorage.getItem('refreshToken'),
                    };
                    localStorage.clear();
                    Object.entries(authTokens).forEach(([key, value]) => {
                      if (value) localStorage.setItem(key, value);
                    });
                    // Hard reload with cache bypass
                    window.location.href = window.location.origin + window.location.pathname + '?v=' + Date.now() + '&_hard=1';
                  })();
                " style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; margin-bottom: 12px;">
                  Clear Cache & Reload
                </button>
                <button onclick="sessionStorage.removeItem('app_reload_attempt'); location.href = location.pathname;" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                  Try Again (Simple Reload)
                </button>
              </div>
            `;
          }
          
          return false;
        }
      }, true); // Use capture phase
      
      // Aggressive cache-busting: Always clear on load to prevent stale code
      (function() {
        const CURRENT_VERSION = '2.3.0';
        const storedVersion = localStorage.getItem('app_version');
        const urlParams = new URLSearchParams(window.location.search);
        const forceClear = urlParams.get('_clear') === '1' || urlParams.get('_nocache') === '1';
        const hardRefresh = urlParams.get('_hard') === '1';
        
        // Don't clear if we're in a reload loop
        if (reloadAttempts >= MAX_RELOAD_ATTEMPTS && isReloadAttempt && !hardRefresh) {
          return; // Already showing error page
        }
        
        // Always clear service workers and caches on hard refresh
        if (hardRefresh || forceClear || (storedVersion && storedVersion !== CURRENT_VERSION) || !storedVersion) {
          // Clear service workers first
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
              registrations.forEach(reg => reg.unregister());
            });
          }
          
          // Clear all caches aggressively
          if ('caches' in window) {
            caches.keys().then(names => {
              names.forEach(name => caches.delete(name).catch(() => {}));
            });
          }
          
          console.log('Clearing cache for version update...');
          
          // Preserve auth tokens
          const authTokens = {
            accessToken: localStorage.getItem('accessToken'),
            refreshToken: localStorage.getItem('refreshToken'),
          };
          
          // Clear everything but keep reload counter
          const reloadCounter = sessionStorage.getItem(RELOAD_ATTEMPT_KEY);
          localStorage.clear();
          sessionStorage.clear();
          if (reloadCounter) sessionStorage.setItem(RELOAD_ATTEMPT_KEY, reloadCounter);
          
          // Restore auth
          Object.entries(authTokens).forEach(([key, value]) => {
            if (value) localStorage.setItem(key, value);
          });
          localStorage.setItem('app_version', CURRENT_VERSION);
          
          // On hard refresh, reset counter and clean URL
          if (hardRefresh) {
            sessionStorage.removeItem(RELOAD_ATTEMPT_KEY);
            const cleanUrl = window.location.href.split('?')[0];
            if (window.location.href !== cleanUrl) {
              window.history.replaceState({}, '', cleanUrl);
            }
          } else if (forceClear && reloadAttempts < MAX_RELOAD_ATTEMPTS) {
            const cleanUrl = window.location.href.split('?')[0];
            if (window.location.href !== cleanUrl) {
              window.history.replaceState({}, '', cleanUrl);
            }
          } else if (storedVersion && storedVersion !== CURRENT_VERSION && reloadAttempts < MAX_RELOAD_ATTEMPTS) {
            // Force reload with cache bypass
            window.location.replace(window.location.href.split('?')[0] + '?v=' + Date.now() + '&_clear=1');
          }
        } else if (isReloadAttempt) {
          // Reset reload counter on successful load
          sessionStorage.removeItem(RELOAD_ATTEMPT_KEY);
          const cleanUrl = window.location.href.split('?')[0];
          if (window.location.href !== cleanUrl) {
            window.history.replaceState({}, '', cleanUrl);
          }
        }
      })();
    </script>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
